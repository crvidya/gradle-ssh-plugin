<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Gradle SSH Plugin by int128</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Gradle SSH Plugin</h1>
        <p class="header">A Gradle plugin providing remote command execution and file transfer capabilities</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/int128/gradle-ssh-plugin/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/int128/gradle-ssh-plugin/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/int128/gradle-ssh-plugin">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/int128">int128</a></p>


      </header>
      <section>
        <h1>
<a name="gradle-ssh-plugin-" class="anchor" href="#gradle-ssh-plugin-"><span class="octicon octicon-link"></span></a>Gradle SSH Plugin <a href="https://travis-ci.org/int128/gradle-ssh-plugin"><img src="https://travis-ci.org/int128/gradle-ssh-plugin.png?branch=master" alt="Build Status"></a>
</h1>

<p>This plugin provides remote command execution and file transfer capabilities.</p>

<p>See also <a href="acceptance-test/features.gradle">test features</a> and <a href="https://github.com/int128/gradle-ssh-plugin/releases">release note</a>.</p>

<h2>
<a name="how-to-use" class="anchor" href="#how-to-use"><span class="octicon octicon-link"></span></a>How to use</h2>

<p>Add a dependency and apply it in your build.gradle:</p>

<div class="highlight highlight-groovy"><pre><span class="n">buildscript</span> <span class="o">{</span>
  <span class="n">repositories</span> <span class="o">{</span>
    <span class="n">mavenCentral</span><span class="o">()</span>
  <span class="o">}</span>
  <span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">classpath</span> <span class="s1">'org.hidetake:gradle-ssh-plugin:0.2.2'</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'ssh'</span>
</pre></div>

<h2>
<a name="define-remote-hosts" class="anchor" href="#define-remote-hosts"><span class="octicon octicon-link"></span></a>Define remote hosts</h2>

<p>At first, define remote hosts:</p>

<div class="highlight highlight-groovy"><pre><span class="n">remotes</span> <span class="o">{</span>
  <span class="n">web01</span> <span class="o">{</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s1">'192.168.1.101'</span>
    <span class="n">user</span> <span class="o">=</span> <span class="s1">'jenkins'</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">properties</span><span class="o">[</span><span class="s1">'ssh.password'</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h2>
<a name="define-a-ssh-task" class="anchor" href="#define-a-ssh-task"><span class="octicon octicon-link"></span></a>Define a SSH task</h2>

<p>To define a SSH task, use <code>task(type: SshTask)</code> like:</p>

<div class="highlight highlight-groovy"><pre><span class="n">task</span> <span class="nf">checkWebServer</span><span class="o">(</span><span class="nl">type:</span> <span class="n">SshTask</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">session</span><span class="o">(</span><span class="n">remotes</span><span class="o">.</span><span class="na">web01</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">pids</span> <span class="o">=</span> <span class="n">execute</span><span class="o">(</span><span class="s1">'pidof nginx'</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="s">/ /</span><span class="o">)</span>
    <span class="k">assert</span> <span class="n">pids</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">task</span> <span class="nf">reloadServers</span><span class="o">(</span><span class="nl">type:</span> <span class="n">SshTask</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">session</span><span class="o">(</span><span class="n">remotes</span><span class="o">.</span><span class="na">role</span><span class="o">(</span><span class="s1">'webServers'</span><span class="o">,</span> <span class="s1">'dbServers'</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">executeBackground</span><span class="o">(</span><span class="s1">'sudo service httpd reload'</span><span class="o">,</span> <span class="nl">pty:</span> <span class="kc">true</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h3>
<a name="execute-a-command" class="anchor" href="#execute-a-command"><span class="octicon octicon-link"></span></a>Execute a command</h3>

<p>In the <code>session</code> closure, following methods are available:</p>

<ul>
<li>
<code>execute(command)</code> - Executes a command. This method blocks until the command is completed and returns output of the command.</li>
<li>
<code>executeSudo(command)</code> - Executes a command as sudo (prepends sudo -S -p). Used to support sudo commands requiring password. This method blocks until the command is completed and returns output of the command.</li>
<li>
<code>executeBackground(command)</code> - Executes a command in background. Other operations will be performed concurrently.</li>
<li>
<code>shell</code> - Opens a shell. This method blocks until the shell is finished. Note that you should provide termination input such as <code>exit</code> or <code>quit</code> with the interaction closure.</li>
</ul><h4>
<a name="interact-with-the-stream" class="anchor" href="#interact-with-the-stream"><span class="octicon octicon-link"></span></a>Interact with the stream</h4>

<p><code>execute</code> and <code>shell</code> method can take a closure for interaction.</p>

<div class="highlight highlight-groovy"><pre><span class="n">execute</span><span class="o">(</span><span class="s1">'passwd'</span><span class="o">,</span> <span class="nl">pty:</span> <span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">interaction</span> <span class="o">{</span>
    <span class="n">when</span><span class="o">(</span><span class="nl">partial:</span> <span class="o">~</span><span class="s">/.+[Pp]assowrd: */</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">standardInput</span> <span class="o">&lt;&lt;</span> <span class="n">oldPassword</span> <span class="o">&lt;&lt;</span> <span class="s1">'\n'</span>
      <span class="n">when</span><span class="o">(</span><span class="nl">partial:</span> <span class="o">~</span><span class="s">/.+[Pp]assowrd: */</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">standardInput</span> <span class="o">&lt;&lt;</span> <span class="n">newPassword</span> <span class="o">&lt;&lt;</span> <span class="s1">'\n'</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h3>
<a name="transfer-a-file-or-directory" class="anchor" href="#transfer-a-file-or-directory"><span class="octicon octicon-link"></span></a>Transfer a file or directory</h3>

<p>In the <code>session</code> closure, following methods are available:</p>

<ul>
<li>
<code>get(remote, local)</code> - Fetches a file or directory from remote host.</li>
<li>
<code>put(local, remote)</code> - Sends a file or directory to remote host.</li>
</ul><h2>
<a name="use-ssh-in-the-task" class="anchor" href="#use-ssh-in-the-task"><span class="octicon octicon-link"></span></a>Use SSH in the task</h2>

<p>To execute SSH in the task, call <code>sshexec()</code> method with a closure:</p>

<div class="highlight highlight-groovy"><pre><span class="n">task</span> <span class="n">prepareEnvironment</span> <span class="o">{</span>
  <span class="n">doLast</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">operation</span> <span class="o">=</span> <span class="s1">'reload'</span>
    <span class="n">sshexec</span> <span class="o">{</span>
      <span class="n">session</span><span class="o">(</span><span class="n">remotes</span><span class="o">.</span><span class="na">role</span><span class="o">(</span><span class="s1">'webServers'</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">execute</span><span class="o">(</span><span class="s2">"sudo service httpd ${operation}"</span><span class="o">,</span> <span class="nl">pty:</span> <span class="kc">true</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h2>
<a name="global-settings" class="anchor" href="#global-settings"><span class="octicon octicon-link"></span></a>Global settings</h2>

<p>Global settings can be defined in the <code>ssh</code> closure:</p>

<div class="highlight highlight-groovy"><pre><span class="n">ssh</span> <span class="o">{</span>
  <span class="n">dryRun</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="n">identity</span> <span class="o">=</span> <span class="n">file</span><span class="o">(</span><span class="s1">'config/identity.key'</span><span class="o">)</span>
  <span class="n">config</span><span class="o">(</span><span class="nl">StrictHostKeyChecking:</span> <span class="s1">'no'</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
      </section>
      <footer>
        <p><small>Hosted on <a href="http://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
